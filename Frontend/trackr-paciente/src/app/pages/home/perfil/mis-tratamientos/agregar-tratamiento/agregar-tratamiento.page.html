<ion-content>
  <form [formGroup]="formTratamiento">

    <ion-grid>
      
      <ion-row>
        <ion-col>
          <div class="form-group">
            <ion-input
              class="readonly"
              [value]="formTratamiento.get('fechaRegistro')?.value | date: 'dd.MM.yyyy'" 
              id="date"
              readonly              
              placeholder="Fecha"
              label="Fecha"
              label-placement="floating"
              fill="outline"
              shape="round">
            </ion-input>
            <ion-icon slot="end" name="calendar-outline"></ion-icon>
          </div>
        </ion-col>
        <ion-col class="form-group">
          <ion-input 
            formControlName="farmaco"
            placeholder="Fármaco"
            label="Fármaco"
            label-placement="floating"
            fill="outline"
            shape="round">
          </ion-input>
        </ion-col>
      </ion-row>

      <ion-row>
        <ion-col class="form-group">
          <ion-input
            formControlName="cantidad"
            placeholder="Cantidad"
            label="Cantidad"
            label-placement="floating"
            type="number"
            fill="outline"
            shape="round">
          </ion-input>
        </ion-col>
        <ion-col class="form-group">
          <ion-input 
            formControlName="unidad"
            placeholder="Unidad"
            label="Unidad"
            label-placement="floating"
            fill="outline"
            shape="round">
          </ion-input>
        </ion-col>
      </ion-row>

      <ion-row>
        <ion-col class="form-group">
          <ion-input
            formControlName="indicaciones"
            placeholder="Indicaciones"
            label="Indicaciones"
            label-placement="floating"
            fill="outline"
            shape="round">
          </ion-input>
        </ion-col>
      </ion-row>

      <ion-row>
        <ion-col class="form-group">
          <ion-select
            formControlName="idPadecimiento" 
            interface="popover"
            placeholder="Seleccionar"
            label="Padecimiento Asociado"
            label-placement="floating"
            fill="outline"
            shape="round">
            <ion-select-option *ngFor="let padecimiento of padecimientos$ | async"
              [value]="padecimiento.id">{{padecimiento.nombre}}</ion-select-option>
          </ion-select>
        </ion-col>
      </ion-row>

      <ion-row>
        <ion-col class="form-group">
          <ion-select 
            formControlName="idUsuarioDoctor"
            interface="popover"
            placeholder="Seleccionar"
            label="Doctor"
            label-placement="floating"
            fill="outline"
            shape="round">
            <ion-select-option *ngFor="let doctor of doctores$ | async"
              [value]="doctor.id">{{doctor.nombre}}</ion-select-option>
          </ion-select>
        </ion-col>
      </ion-row>


      <ion-row>
        <ion-col>
          <ion-toggle formControlName="tratamientoPermanente">Tratamiento permanente</ion-toggle>
        </ion-col>
      </ion-row>

      <ion-row>
        <ion-col size="6">
          <div class="form-group">
            <ion-input
              [value]="formTratamiento.get('fechaInicio')?.value | date: 'dd.MM.yyyy'"
              id="date"
              (click)="openDateModal('fechaInicio')"
              readonly
              label="Fecha Inicio"
              label-placement="floating"
              fill="outline"
              shape="round">
            </ion-input>
            <ion-icon slot="end" name="calendar-outline"></ion-icon>
          </div>
        </ion-col>
        <ion-col size="6" [hidden]="formTratamiento.get('tratamientoPermanente')?.value">
          <div class="form-group">
            <ion-input
              [value]="formTratamiento.get('fechaFin')?.value | date: 'dd.MM.yyyy'"
              id="date"
              (click)="openDateModal('fechaFin')"
              readonly
              label="Fecha Fin"
              label-placement="floating"
              fill="outline"
              shape="round">
            </ion-input>
            <ion-icon slot="end" name="calendar-outline"></ion-icon>
          </div>
        </ion-col>
      </ion-row>


      <ion-row>
        <ion-col>
          <div class="form-group form-group-camera">
            <ion-label>Tomar Fotografía Fármaco</ion-label>
            <ion-input (click)="addPhotoToGallery()" readonly></ion-input>
            <ion-icon slot="start" name="camera"></ion-icon>
          </div>
        </ion-col>
      </ion-row>

      <ion-row [hidden]="!photo" class="centered">
        <ion-col size="2">
          <ion-img [src]="'data:image/jpeg;base64,' + photo?.base64String"></ion-img>
        </ion-col>
      </ion-row>

      <ion-row>
        <ion-col>
          <ion-toggle formControlName="recordatorioActivo">Activar Recordatorio de tomas</ion-toggle>
        </ion-col>
      </ion-row>

      <div [hidden]="!formTratamiento.get('recordatorioActivo')?.value">

        <ion-row>
          <ion-col>
            <ion-label>Días de la semana</ion-label>
          </ion-col>
        </ion-row>

        <ion-row formArrayName="diaSemana">
          <ion-col *ngFor="let day of weekDays; let i = index" class="checkbox-container">
            <ion-checkbox [formControlName]="i"></ion-checkbox>
            <ion-label class="checkbox-label">{{day}}</ion-label>
          </ion-col>
        </ion-row>

        <div formArrayName="horas">
          <ion-row *ngFor="let horaControl of horas.controls; let i = index; let isLast = last" class="mt-3">
            <ion-col size="auto" class="form-group mt-0">
              <ion-input
                [value]="horaControl.value | date: 'HH:mm'"
                (click)="openTimeModal(i)"
                readonly                      
                label="Horario(h)"
                label-placement="floating"
                fill="outline"
                shape="round">
              </ion-input>
              <ion-icon slot="end" name="time-outline"></ion-icon>
            </ion-col>
            <ion-col size="auto">
              <ion-button *ngIf="!isLast" (click)="removeHour(i)">
                <ion-icon name="close-outline"></ion-icon>
              </ion-button>
              <ion-button *ngIf="isLast" (click)="addHour()">
                <ion-icon name="add-outline"></ion-icon>
              </ion-button>
            </ion-col>
          </ion-row>
        </div>

      </div>

      <ion-row>
        <ion-col>
          <ion-label>Se notificara 15 min. antes de la hora establecida.</ion-label>
          <ion-button [disabled]="!formTratamiento.valid" (click)="submitForm()">Guardar</ion-button>
        </ion-col>
      </ion-row>

    </ion-grid>
  </form>

  <ion-datetime-button datetime="timeModal" hidden></ion-datetime-button>
  <ion-modal [keepContentsMounted]="true" [isOpen]="showTimeModal" (didDismiss)="closeTimeModal()">
    <ng-template>
      <ion-datetime id="timeModal" presentation="time" [showDefaultButtons]="true" [(ngModel)]="selectedDate"
        doneText="Confirmar" cancelText="Cancelar"></ion-datetime>
    </ng-template>
  </ion-modal>

  <ion-datetime-button datetime="dateModal" hidden></ion-datetime-button>
  <ion-modal [keepContentsMounted]="true" [isOpen]="showDateModal" (didDismiss)="closeDateModal()">
    <ng-template>
      <ion-datetime id="dateModal" presentation="date" [showDefaultButtons]="true" [(ngModel)]="selectedDate"
        doneText="Confirmar" cancelText="Cancelar"></ion-datetime>
    </ng-template>
  </ion-modal>
</ion-content>